<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="EdgarDing Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="http://www.edgarding.cn/img/home-bg-main.jpg">
    <meta property="twitter:image" content="http://www.edgarding.cn/img/home-bg-main.jpg" />
    

    
    <meta name="title" content="Datadog Agent部署" />
    <meta property="og:title" content="Datadog Agent部署" />
    <meta property="twitter:title" content="Datadog Agent部署" />
    

    
    <meta name="description" content="一天又一天">
    <meta property="og:description" content="一天又一天" />
    <meta property="twitter:description" content="一天又一天" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="Edgarding, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Datadog Agent部署 | EdgarDing 的博客 | One day One day</title>

    <link rel="canonical" href="/post/2021/datadog-agent%E9%83%A8%E7%BD%B2-datadogagent-bu-shu/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">EdgarDing Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/%E7%AE%97%E6%B3%95">算法</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/archive/">ARCHIVE</a></li>
                    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
		    <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/home-bg-main.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/cloud-native" title="Cloud Native">
                            Cloud Native
                        </a>
                        
                    </div>
                    <h1>Datadog Agent部署</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                    EdgarDing Blog
                             
                            on 
                            Tuesday, September 14, 2021
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h1 id="datadog-agent-部署">Datadog Agent 部署</h1>
<blockquote>
<p>Datadog Cluster Agent提供了一种简化的集中式方法来收集集群级别的监视数据。通过充当API服务器和基于节点的代理之间的代理，群集代理有助于减轻服务器负载。</p>
</blockquote>
<p>原先的Node Agent都需要单独查询Kubernetes Api Server的数据，以收集有关整个集群的关键metadata。</p>
<p>
  <img src="https://cdn.jsdelivr.net/gh/edgarding77/images@latest/wallpaper/datadog.png" alt="">

</p>
<h2 id="部署">部署</h2>
<p><a href="https://www.datadoghq.com/blog/monitoring-kubernetes-with-datadog/">https://www.datadoghq.com/blog/monitoring-kubernetes-with-datadog/</a></p>
<p><a href="https://medium.com/@while1eq1/installing-datadog-agent-in-kubernetes-8b9f6ca491c1">https://medium.com/@while1eq1/installing-datadog-agent-in-kubernetes-8b9f6ca491c1</a></p>
<h3 id="部署建议">部署建议</h3>
<p>部署agent的容器化版本，通过容器化的agent作为DaemonSet部署到集群中，可以确保集群中的每台主机上都可以运行该Agent的一个副本。</p>
<p>Datadog Cluster Agent：</p>
<ul>
<li>
<p>通过充当在API server和基于节点的Agetns的proxy来减少Kubernetes API Server采集集群级数据的负载</p>
</li>
<li>
<p>通过减少基于节点代理所需的权限来提供额外的安全性</p>
</li>
<li>
<p>使用Datadog收集的任何指标启用Kubernetes工作负载的自动拓展</p>
</li>
</ul>
<h2 id="步骤">步骤</h2>
<p>创建命名空间 datadog-namespace.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#ff79c6">piVersion</span>: v1
<span style="color:#ff79c6">kind</span>: Namespace
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: datadog
</code></pre></div><p><strong>在Agent 和 Cluster Agent中添加DD_DD_URL和DD_SITE字段。</strong></p>
<h2 id="node-agent">Node Agent</h2>
<p>组件：</p>
<ul>
<li>
<p>agent</p>
</li>
<li>
<p>trace-agent</p>
</li>
<li>
<p>process-agent</p>
</li>
<li>
<p>system-probe</p>
</li>
<li>
<p>security-agent</p>
</li>
</ul>
<p>1、配置Agent权限</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">kubectl apply -f <span style="color:#f1fa8c">&#34;https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/clusterrole.yaml&#34;</span>
<span style="color:#6272a4"># 为Pod中运行的进程提供标识，当Pod中的进程访问集群的时候，API Server将它们作为特定的服务账户进行身份验证。</span>
kubectl apply -f <span style="color:#f1fa8c">&#34;https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/serviceaccount.yaml&#34;</span>

kubectl apply -f <span style="color:#f1fa8c">&#34;https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/clusterrolebinding.yaml&#34;</span>
</code></pre></div><blockquote>
<p>注意：需要修改namesapce，默认为Default，可以改为datadog</p>
</blockquote>
<p>2、创建一个secret包含Datadog API key，这个secret用于资源文件去部署Datadog Agent</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="color:#8be9fd;font-style:italic">echo</span> -n <span style="color:#f1fa8c">&#39;my_datadog_agent_api_key&#39;</span> | base64
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">kubectl create secret generic datadog-agent --from-literal<span style="color:#ff79c6">=</span>api-key<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;&lt;DATADOG_API_KEY&gt;&#39;</span> --namespace<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;datadog&#34;</span>
</code></pre></div><p>注意：&ndash;from-literal=<!-- raw HTML omitted -->=<!-- raw HTML omitted -->提供Secret数据，如果有自定义namespace，需要进行修改。</p>
<h4 id="npm的开启">NPM的开启</h4>
<p>1、添加annotation在agent template</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#ff79c6">spec</span>:
    <span style="color:#ff79c6">selector</span>:
        <span style="color:#ff79c6">matchLabels</span>:
            <span style="color:#ff79c6">app</span>: datadog-agent
    <span style="color:#ff79c6">template</span>:
        <span style="color:#ff79c6">metadata</span>:
            <span style="color:#ff79c6">labels</span>:
                <span style="color:#ff79c6">app</span>: datadog-agent
            <span style="color:#ff79c6">name</span>: datadog-agent
            <span style="color:#ff79c6">annotations</span>:
                <span style="color:#ff79c6">container.apparmor.security.beta.kubernetes.io/system-probe</span>: unconfined
</code></pre></div><p>2、添加环境变量到Procss Agent容器中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">  <span style="color:#6272a4"># (...)</span>
                  <span style="color:#ff79c6">env</span>:
                  <span style="color:#6272a4"># (...)</span>
                      - <span style="color:#ff79c6">name</span>: DD_PROCESS_AGENT_ENABLED
                        <span style="color:#ff79c6">value</span>: <span style="color:#f1fa8c">&#39;true&#39;</span>
                      - <span style="color:#ff79c6">name</span>: DD_SYSTEM_PROBE_ENABLED
                        <span style="color:#ff79c6">value</span>: <span style="color:#f1fa8c">&#39;true&#39;</span>
                      - <span style="color:#ff79c6">name</span>: DD_SYSTEM_PROBE_EXTERNAL
                        <span style="color:#ff79c6">value</span>: <span style="color:#f1fa8c">&#39;true&#39;</span>
                      - <span style="color:#ff79c6">name</span>: DD_SYSPROBE_SOCKET
                        <span style="color:#ff79c6">value</span>: /var/run/sysprobe/sysprobe.sock
</code></pre></div><p>3、挂在到extra volumes到datadog—agent容器上</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"> <span style="color:#6272a4"># (...)</span>
        <span style="color:#ff79c6">spec</span>:
            <span style="color:#ff79c6">serviceAccountName</span>: datadog-agent
            <span style="color:#ff79c6">containers</span>:
                - <span style="color:#ff79c6">name</span>: datadog-agent
                  <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#39;gcr.io/datadoghq/agent:latest&#39;</span>
                  <span style="color:#6272a4"># (...)</span>
              <span style="color:#ff79c6">volumeMounts</span>:
                  - <span style="color:#ff79c6">name</span>: procdir
                    <span style="color:#ff79c6">mountPath</span>: /host/proc
                    <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
                  - <span style="color:#ff79c6">name</span>: cgroups
                    <span style="color:#ff79c6">mountPath</span>: /host/sys/fs/cgroup
                    <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
                  - <span style="color:#ff79c6">name</span>: debugfs
                    <span style="color:#ff79c6">mountPath</span>: /sys/kernel/debug
                  - <span style="color:#ff79c6">name</span>: sysprobe-socket-dir
                    <span style="color:#ff79c6">mountPath</span>: /var/run/sysprobe 
</code></pre></div><p>4、添加一个新的system-probe作为side car到Agent</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"> <span style="color:#6272a4"># (...)</span>
                - <span style="color:#ff79c6">name</span>: system-probe
                  <span style="color:#ff79c6">image</span>: <span style="color:#f1fa8c">&#39;datadog/agent:latest&#39;</span>
                  <span style="color:#ff79c6">imagePullPolicy</span>: Always
                  <span style="color:#ff79c6">securityContext</span>:
                      <span style="color:#ff79c6">capabilities</span>:
                          <span style="color:#ff79c6">add</span>:
                              - SYS_ADMIN
                              - SYS_RESOURCE
                              - SYS_PTRACE
                              - NET_ADMIN
                              - IPC_LOCK
                  <span style="color:#ff79c6">command</span>:
                      - /opt/datadog-agent/embedded/bin/system-probe
                  <span style="color:#ff79c6">env</span>:
                      - <span style="color:#ff79c6">name</span>: DD_SYSPROBE_SOCKET
                        <span style="color:#ff79c6">value</span>: /var/run/sysprobe/sysprobe.sock
                  <span style="color:#ff79c6">resources</span>:
                      <span style="color:#ff79c6">requests</span>:
                          <span style="color:#ff79c6">memory</span>: 150Mi
                          <span style="color:#ff79c6">cpu</span>: 200m
                      <span style="color:#ff79c6">limits</span>:
                          <span style="color:#ff79c6">memory</span>: 150Mi
                          <span style="color:#ff79c6">cpu</span>: 200m
                  <span style="color:#ff79c6">volumeMounts</span>:
                      - <span style="color:#ff79c6">name</span>: procdir
                        <span style="color:#ff79c6">mountPath</span>: /host/proc
                        <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
                      - <span style="color:#ff79c6">name</span>: cgroups
                        <span style="color:#ff79c6">mountPath</span>: /host/sys/fs/cgroup
                        <span style="color:#ff79c6">readOnly</span>: <span style="color:#ff79c6">true</span>
                      - <span style="color:#ff79c6">name</span>: debugfs
                        <span style="color:#ff79c6">mountPath</span>: /sys/kernel/debug
                      - <span style="color:#ff79c6">name</span>: sysprobe-socket-dir
                        <span style="color:#ff79c6">mountPath</span>: /var/run/sysprobe
</code></pre></div><p>5、volumes</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">   <span style="color:#ff79c6">volumes</span>:
                - <span style="color:#ff79c6">name</span>: sysprobe-socket-dir
                  <span style="color:#ff79c6">emptyDir</span>: {}
                - <span style="color:#ff79c6">name</span>: debugfs
                  <span style="color:#ff79c6">hostPath</span>:
                      <span style="color:#ff79c6">path</span>: /sys/kernel/debug
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">
2021-04-28 08:24:38 UTC | SYS-PROBE | INFO | <span style="color:#ff79c6">(</span>cmd/system-probe/loader.go:50 in Register<span style="color:#ff79c6">)</span> | module: network_tracer started
2021-04-28 08:24:38 UTC | SYS-PROBE | INFO | <span style="color:#ff79c6">(</span>cmd/system-probe/modules/tcp_queue_tracer.go:21 in func4<span style="color:#ff79c6">)</span> | TCP queue length tracer disabled
2021-04-28 08:24:38 UTC | SYS-PROBE | INFO | <span style="color:#ff79c6">(</span>cmd/system-probe/modules/oom_kill_probe.go:20 in func2<span style="color:#ff79c6">)</span> | OOM <span style="color:#8be9fd;font-style:italic">kill</span> probe disabled
2021-04-28 08:24:40 UTC | SYS-PROBE | ERROR | <span style="color:#ff79c6">(</span>cmd/system-probe/loader.go:44 in Register<span style="color:#ff79c6">)</span> | error registering HTTP endpoints <span style="color:#ff79c6">for</span> module <span style="color:#f1fa8c">`</span>security_runtime<span style="color:#f1fa8c">`</span> error: failed to init probe: failed to init manager: couldn&#39;t load eBPF programs: map syscalls: map create: invalid argument
</code></pre></div><h2 id="cluster-agent">Cluster Agent</h2>
<p>1、安装Datadog Cluster Agent</p>
<p>2、配置Agent与Datadog Cluster Agent的通信</p>
<h3 id="配置datadog-cluster-agent">配置Datadog Cluster Agent</h3>
<h4 id="配置rbac-权限">配置RBAC 权限</h4>
<blockquote>
<p>当使用Cluster Agent与Kubernetes API Server通信的时候，Node Agent将会失效，只有Cluster Agent可以进行</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="color:#6272a4"># 若配置上面node-rbac.yaml 将会更新node 的clusterRole，可以忽略node-rbac</span>
kubectl apply -f <span style="color:#f1fa8c">&#34;https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/rbac.yaml&#34;</span>
<span style="color:#6272a4"># </span>
kubectl apply -f <span style="color:#f1fa8c">&#34;https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/cluster-agent-rbac.yaml&#34;</span>
</code></pre></div><p>将会创建适当的<code>ServiceAccount</code>、<code>ClusterRole</code>和<code>ClusterRoleBinding</code>为Cluster Agent，同时更新<code>ClusterRole</code>对于Node Agent。</p>
<h4 id="cluster-agent-与-agent的通信安全">Cluster Agent 与 Agent的通信安全</h4>
<blockquote>
<p>用于保护Cluster-Agent和Node-Agent的通信安全 —— datadog-cluster-agent</p>
</blockquote>
<p>注意：token必须至少32个字符长</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"> <span style="color:#8be9fd;font-style:italic">echo</span> -n <span style="color:#f1fa8c">&#39;my_datadog_cluster_agent_token&#39;</span> | base64
 bXlfZGF0YWRvZ19jbHVzdGVyX2FnZW50X3Rva2Vu 
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">kubectl create secret generic datadog-cluster-agent --from-literal<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">token</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;bXlfZGF0YWRvZ19jbHVzdGVyX2FnZW50X3Rva2Vu&#39;</span> --namespace<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;datadog&#34;</span>  
</code></pre></div><p>创建一个name=datadog-cluster-agent的secret</p>
<p><code>DD_CLUSTER_AGENT_AUTH_TOKEN</code>将会在Cluter Agent manifest中使用</p>
<p>注意：需要被设置在Cluster Agent和Node Agent的manifest文件中</p>
<p>使用配置文件创建样例：secrets.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#6272a4"># secret-api-key.yaml</span>
<span style="color:#ff79c6">apiVersion</span>: v1
<span style="color:#ff79c6">kind</span>: Secret
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: datadog
  <span style="color:#ff79c6">labels</span>: {}
<span style="color:#ff79c6">type</span>: Opaque
<span style="color:#ff79c6">data</span>:
  <span style="color:#ff79c6">api-key</span>: PUT_YOUR_BASE64_ENCODED_API_KEY_HERE
--- 
<span style="color:#6272a4"># secret-cluster-agent-token.yaml</span>
<span style="color:#ff79c6">apiVersion</span>: v1
<span style="color:#ff79c6">kind</span>: Secret
<span style="color:#ff79c6">metadata</span>:
  <span style="color:#ff79c6">name</span>: datadog-cluster-agent
  <span style="color:#ff79c6">labels</span>: {}
<span style="color:#ff79c6">type</span>: Opaque
<span style="color:#ff79c6">data</span>:
  <span style="color:#ff79c6">token</span>: PUT_A_BASE64_ENCODED_RANDOM_STRING_HERE
</code></pre></div><h4 id="创建cluster-agnet和它的service">创建Cluster Agnet和它的Service</h4>
<ul>
<li>
<p><a href="https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/agent-services.yaml"><code>agent-services.yaml</code></a><a href="https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/agent-services.yaml">: The Cluster Agent Service manifest</a></p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/secrets.yaml"><code>secrets.yaml</code></a><a href="https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/secrets.yaml">: The secret holding the Datadog API key</a></p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/cluster-agent-deployment.yaml"><code>cluster-agent-deployment.yaml</code></a><a href="https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/cluster-agent-deployment.yaml">: Cluster Agent manifest</a></p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/install_info-configmap.yaml"><code>install_info-configmap.yaml</code></a><a href="https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/cluster-agent/install_info-configmap.yaml">: Install Info Configmap</a></p>
</li>
</ul>
<p>1、在secrets.yaml，替换Datadog API key —— datadog</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="color:#8be9fd;font-style:italic">echo</span> -n <span style="color:#f1fa8c">&#39;my_datadog_cluster_agent_api&#39;</span> | base64
<span style="color:#8be9fd;font-style:italic">bXlfZGF0YWRvZ19jbHVzdGVyX2FnZW50X2FwaQ</span><span style="color:#ff79c6">==</span> 
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">kubectl create secret generic datadog --from-literal<span style="color:#ff79c6">=</span>api-key<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;bXlfZGF0YWRvZ19jbHVzdGVyX2FnZW50X2FwaQ==&#39;</span> --namespace<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;datadog&#34;</span>
</code></pre></div><p>2、在cluster-agent-deployment.yaml中设置token根据创建方式。</p>
<p>3、依次run agent-services、secrets、install_info-configmap</p>
<p>4、最后run datadog Cluster-Agent-deployment</p>
<p>5、在安装完Datadog CLuster Agent后，配置Datadog Agnet去与Datadog Cluster Agent进行通信。</p>
<p>注意：修改deployment中的容忍度tolerations</p>
<h3 id="配置datadog-agentnode-agent">配置Datadog Agent（Node Agent）</h3>
<h4 id="为node-base-agents-安装rbac权限">为Node-Base Agents 安装RBAC权限</h4>
<p>agent-rbac.yaml</p>
<h4 id="启用datadog-agent">启用Datadog Agent</h4>
<p>1、下载daemonset.yaml</p>
<p>2、在daemonset，取代DD_SITE的默认值，（用DD_DD_URL代替要Forwarder的地方）</p>
<p>3、在daemonset.yaml中设置token，通过自己创建secret的方式</p>
<p>4、在daemonset.yaml，检查<code>DD_CLUSTER_AGENT_ENABLED</code>是否是true</p>
<p>5、（可选）配置一些单独的环境</p>
<p>6、运行</p>
<p>注意：daemonset和deployment中的image分别需要改为：</p>
<ul>
<li>&ldquo;<a href="http://harbor.od.com/datadog/cluster-agent:latest">harbor.od.com/datadog/cluster-agent:latest</a>&rdquo;</li>
<li>&ldquo;<a href="http://harbor.od.com/datadog/agent:latest">harbor.od.com/datadog/agent:latest</a>&rdquo;</li>
</ul>
<h2 id="问题">问题</h2>
<h3 id="token和api-key未启用">token和API key未启用</h3>
<p>添加optional： true</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">
        <span style="color:#ff79c6">env</span>:
        - <span style="color:#ff79c6">name</span>: DD_API_KEY
          <span style="color:#ff79c6">valueFrom</span>:
            <span style="color:#ff79c6">secretKeyRef</span>:
              <span style="color:#ff79c6">name</span>: <span style="color:#f1fa8c">&#34;datadog&#34;</span>
              <span style="color:#ff79c6">key</span>: api-key
              <span style="color:#ff79c6">optional</span>: <span style="color:#ff79c6">true</span>

</code></pre></div><h3 id="删除命名空间失效">删除命名空间失效</h3>
<p>查找字段“finalizers”，去除“kubernetes”</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">kubectl delete ns &lt;namespace&gt;

kubectl proxy
kubectl get ns &lt;namesapce&gt; -o json &gt; tmp.json


curl -k -H <span style="color:#f1fa8c">&#34;Content-Type: application/json&#34;</span> -X PUT --data-binary @tmp.json http://127.0.0.1:8001/api/v1/namespaces/datadog-agent/finalize
</code></pre></div><h3 id="修复节点不会调度问题">修复节点不会调度问题</h3>
<p>判断节点是否开启</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">
<span style="color:#ff79c6">[</span>root@master-80 main<span style="color:#ff79c6">]</span><span style="color:#6272a4"># kubectl get nodes</span>
NAME      STATUS                     ROLES    AGE   VERSION
node-81   Ready,SchedulingDisabled   &lt;none&gt;   88d   v1.18.15
node-82   Ready                      &lt;none&gt;   88d   v1.18.15

</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">kubectl uncordon &lt;node-name&gt;
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">    <span style="color:#ff79c6">tolerations</span>:
      - <span style="color:#ff79c6">key</span>: CriticalAddonsOnly
        <span style="color:#ff79c6">operator</span>: Exists
      - <span style="color:#ff79c6">effect</span>: NoSchedule
        <span style="color:#ff79c6">operator</span>: Exists
      - <span style="color:#ff79c6">effect</span>: NoExecute
        <span style="color:#ff79c6">operator</span>: Exists
</code></pre></div><p>修改tolerations</p>
<h3 id="error-secret-datadog-appkey-not-found">Error: secret &ldquo;datadog-appkey&rdquo; not found</h3>
<p>删除，否则会导致容器创建失败</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">        - <span style="color:#ff79c6">name</span>: DD_APP_KEY
          <span style="color:#ff79c6">valueFrom</span>:
            <span style="color:#ff79c6">secretKeyRef</span>:
              <span style="color:#ff79c6">name</span>: <span style="color:#f1fa8c">&#34;datadog-agent&#34;</span>
              <span style="color:#ff79c6">key</span>: app-key
              <span style="color:#ff79c6">optional</span>: <span style="color:#ff79c6">true</span>
</code></pre></div><h3 id="image-gc-failed">？image GC failed</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="color:#ff79c6">{</span>
        <span style="color:#f1fa8c">&#34;apiKey&#34;</span>:<span style="color:#f1fa8c">&#34;&#34;</span>,
        <span style="color:#f1fa8c">&#34;internalHostname&#34;</span>:<span style="color:#f1fa8c">&#34;node-82&#34;</span>,
        <span style="color:#f1fa8c">&#34;events&#34;</span>:<span style="color:#ff79c6">{</span>
                <span style="color:#f1fa8c">&#34;kubernetes&#34;</span>:<span style="color:#ff79c6">[</span>
                        <span style="color:#ff79c6">{</span>
                                <span style="color:#f1fa8c">&#34;aggregation_key&#34;</span>:<span style="color:#f1fa8c">&#34;kubernetes_apiserver:node-81&#34;</span>,
                                <span style="color:#f1fa8c">&#34;event_type&#34;</span>:<span style="color:#f1fa8c">&#34;kubernetes_apiserver&#34;</span>,
                                <span style="color:#f1fa8c">&#34;msg_title&#34;</span>:<span style="color:#f1fa8c">&#34;Events from the Node node-81&#34;</span>,
                                <span style="color:#f1fa8c">&#34;host&#34;</span>:<span style="color:#f1fa8c">&#34;node-81&#34;</span>,
                                <span style="color:#f1fa8c">&#34;msg_text&#34;</span>:<span style="color:#f1fa8c">&#34;%%% \n4541 **ImageGCFailed**: (combined from                                                                                                                           similar events): wanted to free 15911626342 bytes, but freed 0 bytes space with errors                                                                                                                           in image deletion: rpc error: code = Unknown desc = Error response from daemon: conflict                                                                                                                          : unable to remove repository reference \&#34;nginx_new:latest\&#34; (must force) - container 68                                                                                                                          ca1f2b153a is using its referenced image 264637614cff\n \n _Events emitted by the kubele                                                                                                                          t seen at 2021-04-22 03:39:29 +0000 UTC since 2021-04-06 08:23:15 +0000 UTC_ \n\n %%%&#34;</span>,
                                <span style="color:#f1fa8c">&#34;priority&#34;</span>:<span style="color:#f1fa8c">&#34;normal&#34;</span>,
                                <span style="color:#f1fa8c">&#34;source_type_name&#34;</span>:<span style="color:#f1fa8c">&#34;kubernetes&#34;</span>,
                                <span style="color:#f1fa8c">&#34;alert_type&#34;</span>:<span style="color:#f1fa8c">&#34;warning&#34;</span>,
                                <span style="color:#f1fa8c">&#34;timestamp&#34;</span>:1619062769,
                                <span style="color:#f1fa8c">&#34;tags&#34;</span>:<span style="color:#ff79c6">[</span>
                                        <span style="color:#f1fa8c">&#34;kubernetes_kind:Node&#34;</span>,
                                        <span style="color:#f1fa8c">&#34;name:node-81&#34;</span>,
                                        <span style="color:#f1fa8c">&#34;source_component:kubelet&#34;</span>
                                <span style="color:#ff79c6">]</span>
                        <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">]</span>
        <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>参考：<a href="https://github.com/kubernetes/kubernetes/issues/71869">https://github.com/kubernetes/kubernetes/issues/71869</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="color:#6272a4"># 以清理出足够的磁盘容量</span>
kubectl drain --delete-local-data --ignore-daemonsets <span style="color:#8be9fd;font-style:italic">$NODE_IP</span> <span style="color:#ff79c6">&amp;&amp;</span> kubectl uncordon <span style="color:#8be9fd;font-style:italic">$NODE_IP</span> 
</code></pre></div><h3 id="node-agent--err-collecting">？node Agent  err collecting</h3>
<p><code>cat /var/log/datadog/agent.log | grep &quot;metadata-collector&quot;</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">| CORE | WARN | <span style="color:#ff79c6">(</span>pkg/tagger/local/tagger.go:251 in Tag<span style="color:#ff79c6">)</span> | error collecting from kube-metadata-collector: couldn<span style="color:#f1fa8c">&#39;t fetch &#34;podlist&#34;: unexpected status code 401 on https://10.230.4.81:10250    /pods: Unauthorized
</span><span style="color:#f1fa8c">
</span><span style="color:#f1fa8c">error collecting from kube-metadata-collector: couldn&#39;</span>t fetch <span style="color:#f1fa8c">&#34;podlist&#34;</span>: unexpected status code <span style="color:#bd93f9">401</span> on https://10.230.4.81:10250/pods: Unauthorized

</code></pre></div><p>猜测是因为安装了cluster-agent的缘故导致agent向API Server获取Kubernetes集群的信息失败。</p>
<h3 id="providerid-not-found">？providerID not found</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">| CLUSTER | WARN | <span style="color:#ff79c6">(</span>pkg/collector/corechecks/cluster/kubernetes_eventbundle.go:165 in getHostProviderID<span style="color:#ff79c6">)</span> | ProviderID not found

</code></pre></div><p><a href="https://stackoverflow.com/questions/60288304/what-is-the-way-to-make-kubernetes-nodes-have-providerid-spec-after-creation">https://stackoverflow.com/questions/60288304/what-is-the-way-to-make-kubernetes-nodes-have-providerid-spec-after-creation</a></p>
<blockquote>
<p>provider-id string. Unique identifier for identifying the node in a machine database, i.e cloud provider. (DEPRECATED: This parameter should &hellip;</p>
</blockquote>
<h3 id="not-list-resource-podsecuritypolicies">？not list resource “podsecuritypolicies”</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">      Error: unable to list Kube resources:<span style="color:#f1fa8c">&#39;policy/v1beta1, Resource=podsecuritypolicies&#39;</span>, ns:<span style="color:#f1fa8c">&#39;&#39;</span> name:<span style="color:#f1fa8c">&#39;&#39;</span>, err: podsecuritypolicies.policy is forbidden: User <span style="color:#f1fa8c">&#34;system:serviceaccount:datadog:datadog-cluster-agent&#34;</span> cannot list resource <span style="color:#f1fa8c">&#34;podsecuritypolicies&#34;</span> in API group <span style="color:#f1fa8c">&#34;policy&#34;</span> at the cluster scope
      No traceback
</code></pre></div><h3 id="error-while-processing-transaction">？Error while processing transaction</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"> CLUSTER | ERROR | <span style="color:#ff79c6">(</span>pkg/forwarder/worker.go:178 in process<span style="color:#ff79c6">)</span> | Error <span style="color:#ff79c6">while</span> processing transaction: error <span style="color:#ff79c6">while</span> sending transaction, rescheduling it: Post <span style="color:#f1fa8c">&#34;http://10.230.4.20:12345/intake/?api_key=*************************2FwaQ==&#34;</span>: dial tcp 10.230.4.20:12345: connect: connection refuse
</code></pre></div><h3 id="node-agent-1">node agent</h3>
<p>agent</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">
2021-04-25 09:23:03 UTC | CORE | WARN | <span style="color:#ff79c6">(</span>pkg/tagger/local/tagger.go:251 in Tag<span style="color:#ff79c6">)</span> | error collecting from kubelet: couldn<span style="color:#f1fa8c">&#39;t fetch &#34;podlist&#34;: unexpected status code 401 on https://10.230.4.82:10250/pods: Unauthorized
</span><span style="color:#f1fa8c">2021-04-25 09:23:03 UTC | CORE | WARN | (pkg/tagger/local/tagger.go:206 in pull) | couldn&#39;</span>t fetch <span style="color:#f1fa8c">&#34;podlist&#34;</span>: unexpected status code <span style="color:#bd93f9">401</span> on https://10.230.4.82:10250/pods: Unauthorized
</code></pre></div><p>trace-agent</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">2021-04-25 09:23:22 UTC | TRACE | ERROR | <span style="color:#ff79c6">(</span>pkg/tagger/collectors/kubernetes_main.go:63 in Detect<span style="color:#ff79c6">)</span> | Could not initialise the communication with the cluster agent: temporary failure in clusterAgentClient, will retry later: cannot get a cluster agent endpoint <span style="color:#ff79c6">for</span> kubernetes service DATADOGT_CLUSTER_AGENT, env DATADOGT_CLUSTER_AGENT_SERVICE_HOST is empty
2021-04-25 09:23:22 UTC | TRACE | WARN | <span style="color:#ff79c6">(</span>pkg/tagger/local/tagger.go:206 in pull<span style="color:#ff79c6">)</span> | couldn&#39;t fetch <span style="color:#f1fa8c">&#34;podlist&#34;</span>: unexpected status code <span style="color:#bd93f9">401</span> on https://10.230.4.82:10250/pods: Unauthorized
</code></pre></div><p>process-agent</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">
2021-04-25 09:23:34 UTC | PROCESS | ERROR | <span style="color:#ff79c6">(</span>pkg/forwarder/worker.go:174 in process<span style="color:#ff79c6">)</span> | Too many errors <span style="color:#ff79c6">for</span> endpoint <span style="color:#f1fa8c">&#39;https://process.datadoghq.com/api/v1/collector&#39;</span>: retrying later
2021-04-25 09:23:37 UTC | PROCESS | WARN | <span style="color:#ff79c6">(</span>pkg/tagger/local/tagger.go:206 in pull<span style="color:#ff79c6">)</span> | couldn<span style="color:#f1fa8c">&#39;t fetch &#34;podlist&#34;: unexpected status code 401 on https://10.230.4.82:10250/pods: Unauthorized
</span><span style="color:#f1fa8c">2021-04-25 09:23:41 UTC | PROCESS | ERROR | (pkg/process/util/containers.go:64 in GetContainers) | Cannot list containers via kubelet: could not get pod list: couldn&#39;</span>t fetch <span style="color:#f1fa8c">&#34;podlist&#34;</span>: unexpected status code <span style="color:#bd93f9">401</span> on https://10.230.4.82:10250/pods: Unauthorized

</code></pre></div><p>sysem-probe</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">2021-04-25 09:17:31 UTC | SYS-PROBE | INFO | <span style="color:#ff79c6">(</span>cmd/system-probe/modules/network_tracer.go:129 in logRequests<span style="color:#ff79c6">)</span> | Got request on /connections?client_id<span style="color:#ff79c6">=</span><span style="color:#bd93f9">32460</span> <span style="color:#ff79c6">(</span>count: 6580<span style="color:#ff79c6">)</span>: retrieved <span style="color:#bd93f9">752</span> connections in 73.063134ms
2021-04-25 09:18:21 UTC | SYS-PROBE | INFO | <span style="color:#ff79c6">(</span>pkg/network/dns_snooper.go:214 in logDNSStats<span style="color:#ff79c6">)</span> | DNS Stats. Queries :0, Successes :0, Errors: <span style="color:#bd93f9">752</span>
</code></pre></div><p>security-agent</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">2021-04-25 09:29:18 UTC | SECURITY | ERROR | <span style="color:#ff79c6">(</span>pkg/forwarder/worker.go:178 in process<span style="color:#ff79c6">)</span> | Error <span style="color:#ff79c6">while</span> processing transaction: error <span style="color:#ff79c6">while</span> sending transaction, rescheduling it: Post <span style="color:#f1fa8c">&#34;https://7-26-0-app.agent.datadoghq.com/intake/?api_key=*************************2FwaQ==&#34;</span>: dial tcp: lookup 7-26-0-app.agent.datadoghq.com: Temporary failure in name resolution
2021-04-25 09:29:23 UTC | SECURITY | ERROR | <span style="color:#ff79c6">(</span>pkg/forwarder/worker.go:174 in process<span style="color:#ff79c6">)</span> | Too many errors <span style="color:#ff79c6">for</span> endpoint <span style="color:#f1fa8c">&#39;https://7-26-0-app.agent.datadoghq.com/api/v1/check_run?api_key=*************************2FwaQ==&#39;</span>: retrying later

</code></pre></div><h2 id="基础配置文件">基础配置文件</h2>
<p><a href="https://www.wolai.com/rvm8w1Cva9uqvEW119W5X4">daemonset - 基础版</a></p>
<p><a href="https://www.wolai.com/4RPoft7pwFUkve3v8FESUQ">cluster-agent-deployment</a></p>
<p><a href="https://www.wolai.com/v5nKaXb6jHKWP31ykbXJPW">cluster-agent-rbac</a></p>
<p><a href="https://www.wolai.com/qN9sMrenGzDjyaFi2SCoDz">rbac</a></p>
<h2 id="诊断">诊断</h2>
<p><strong>参考</strong>：</p>
<h3 id="cluster-agent-troubleshooting">Cluster Agent Troubleshooting</h3>
<p>先进入到cluster-agent容器内</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">kubectl <span style="color:#8be9fd;font-style:italic">exec</span> -it &lt;DATADOG_CLUSTER_AGENT_POD_NAME&gt; bash
</code></pre></div><p>执行<code>datadog-cluster-agent metamap</code>，查看Datadog Cluster Agent服务于哪些集群级别的元数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">root@datadog-cluster-agent-6db94974f9-mxtl5:/# datadog-cluster-agent metamap
<span style="color:#ff79c6">error: Error creating expvar server on port 5000: listen tcp 0.0.0.0:5000: bind</span>: address already in use
<span style="color:#ff79c6">2021-04-22 03:10:22 UTC | CLUSTER | INFO | (pkg/util/log/log.go:526 in func1) | Features detected from environment</span>: map[3:{}]
<span style="color:#ff79c6">2021-04-22 03:10:22 UTC | CLUSTER | ERROR | (pkg/util/log/log.go:551 in func1) | Error creating expvar server on port 5000: listen tcp 0.0.0.0:5000: bind</span>: address already in use
2021-04-22 03:10:22 UTC | CLUSTER | WARN | (pkg/util/log/log.go:541 in func1) | Agent configuration relax permissions constraint on the secret backend cmd, Group can read and exec
===============
Metadata Mapper
===============

<span style="color:#ff79c6">Node detected</span>: node-81

  - <span style="color:#ff79c6">Namespace</span>: istio-system
      - <span style="color:#ff79c6">Pod</span>: grafana-775698c4c8-6t46s
        <span style="color:#ff79c6">Services</span>: [grafana]
      - <span style="color:#ff79c6">Pod</span>: kiali-74bcfc7575-cglnt
        <span style="color:#ff79c6">Services</span>: [kiali]

<span style="color:#ff79c6">Node detected</span>: node-82

  - <span style="color:#ff79c6">Namespace</span>: datadog
      - <span style="color:#ff79c6">Pod</span>: datadog-cluster-agent-6db94974f9-mxtl5
        <span style="color:#ff79c6">Services</span>: [datadog-cluster-agent datadog-cluster-agent-metrics-api]

  - <span style="color:#ff79c6">Namespace</span>: elk-flow-collector
      - <span style="color:#ff79c6">Pod</span>: elasticsearch-0
        <span style="color:#ff79c6">Services</span>: [elasticsearch]
      - <span style="color:#ff79c6">Pod</span>: kibana-d5f5889b9-4dfq8
        <span style="color:#ff79c6">Services</span>: [kibana]
      - <span style="color:#ff79c6">Pod</span>: logstash-67468fd8bb-cswn4
        <span style="color:#ff79c6">Services</span>: [logstash]

  - <span style="color:#ff79c6">Namespace</span>: flow-aggregator
      - <span style="color:#ff79c6">Pod</span>: flow-aggregator-849d4865b8-b2v7b
        <span style="color:#ff79c6">Services</span>: [flow-aggregator]

  - <span style="color:#ff79c6">Namespace</span>: istio-system
      - <span style="color:#ff79c6">Pod</span>: jaeger-f5c857df9-9gb5k
        <span style="color:#ff79c6">Services</span>: [jaeger-collector tracing zipkin]
      - <span style="color:#ff79c6">Pod</span>: prometheus-84797dd77c-8p4v8
        <span style="color:#ff79c6">Services</span>: [prometheus]

  - <span style="color:#ff79c6">Namespace</span>: kube-system
      - <span style="color:#ff79c6">Pod</span>: antrea-controller-6dc8cb4469-85cgx
        <span style="color:#ff79c6">Services</span>: [antrea]
      - <span style="color:#ff79c6">Pod</span>: coredns-6bf74754-cv7j7
        <span style="color:#ff79c6">Services</span>: [coredns]
      - <span style="color:#ff79c6">Pod</span>: coredns-6bf74754-dq9z7
        <span style="color:#ff79c6">Services</span>: [coredns]

</code></pre></div><p>验证Datadog Cluster是否正在被查询</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">tail -f /var/log/datadog/cluster-agent.log
</code></pre></div><p>确保如下env为true</p>
<ul>
<li>
<p>Leader election: <code>DD_LEADER_ELECTION</code></p>
</li>
<li>
<p>Event collection: <code>DD_COLLECT_KUBERNETES_EVENTS</code></p>
</li>
</ul>
<p>同时RBAC的verbs（watch events），通过以下命令检查</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">datadog-cluster-agent status
</code></pre></div><h3 id="node-agent-2">Node Agent</h3>
<p>确保Datadog Cluster Agent处于running并可用<code>agent status</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash"><span style="color:#ff79c6">=====================</span>
Datadog Cluster <span style="color:#8be9fd;font-style:italic">Agent</span>
<span style="color:#ff79c6">=====================</span>

  - Datadog Cluster Agent endpoint detected: https://192.168.84.76:5005
  Successfully connected to the Datadog Cluster Agent.
  - Running: 1.11.0+commit.4eadd95

</code></pre></div><p>确保Cluster Agent service创建在Agent pod之前以至于DNS在环境变量中是可用的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">env | grep DATADOG_CLUSTER_AGENT | sort
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">DD_CLUSTER_AGENT_AUTH_TOKEN</span><span style="color:#f1fa8c">}</span> 
</code></pre></div><ul>
<li><input disabled="" type="checkbox"> 验证node agent正在使用Cluster Agent作为tag provider</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">cat /var/log/datadog/agent.log | grep <span style="color:#f1fa8c">&#34;metadata-collector&#34;</span>
</code></pre></div>

                
                
<div class="entry-shang text-center">
    
	    <p>「真诚赞赏，手留余香」</p>
	
	<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><a href="http://www.edgarding.cn"><img src="/img/favicon.png" />EdgarDing Blog</a></span>
        
	        <p class="tip"><i></i><span>真诚赞赏，手留余香</span></p>
		
 
	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
			<button class="btn btn-blink" data-num="100">100元</button>
			<button class="btn btn-blink" data-num="1">任意金额</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
			<img src="/img/reward/wechat-2.png"  id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked"><span ><span class="zs-wechat"><img src="/img/reward/wechat-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" class="zs-alipay"><img src="/img/reward/alipay-btn.png"/></span></label>
	</div>
</div>
<script type="text/javascript" src="/js/reward.js"></script>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2021/%E7%AE%97%E6%B3%95-%E6%8E%92%E5%BA%8F-pai-xu-suan-fa/" data-toggle="tooltip" data-placement="top" title="算法-排序">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2021/kubernetes-%E5%9F%BA%E7%A1%80-kubernetes-ji-chu/" data-toggle="tooltip" data-placement="top" title="Kubernetes-基础">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/%E7%AE%97%E6%B3%95" title="算法">
                            算法
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
                <section>
                    <hr>
                    <h5>FRIENDS</h5>
                    <ul class="list-inline">
                        
                        <li><a target="_blank" href="https://fortuna7.top">oneday oneday 老博客</a></li>
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:edgarding97@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/EdgarDing77">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            <li>
                <a target="_blank" href="https://www.instagram.com/edgarding7/">
                    <span class="fa-stack fa-lg">
                        <i class="fas fa-circle fa-stack-2x"></i>
                        <i class="fab fa-instagram fa-stack-1x fa-inverse"></i>
                    </span>
                </a>
            </li>
            
            
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; EdgarDing Blog 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a>
                    
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>









<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





</body>
</html>
