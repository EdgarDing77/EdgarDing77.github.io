# 部署说明

## 虚拟机配置

实现参考：https://mp.weixin.qq.com/s/WeZLtfrMdnISpX3v5WpJfA

### **网络配置**

系统配置：

- MacOS Monetary
- Linux Centos7.9 

采用了**与我的Mac共享**网络模式。

配置位置：`sudo vim /etc/sysconfig/network-scripts/ifcfg-ens33`

查看vmnet8：`cd /Library/Preferences/VMware\ Fusion/vmnet8`

```bash
# NAT gateway address
ip = 192.168.90.2
netmask = 255.255.255.0
```

获取可用IP地址：`cat dhcpd.conf`

```conf
subnet 192.168.90.0 netmask 255.255.255.0 {
	range 192.168.90.128 192.168.90.254;
	option broadcast-address 192.168.90.255;
	option domain-name-servers 192.168.90.2;
	option domain-name localdomain;
	default-lease-time 1800;                # default is 30 minutes
	max-lease-time 7200;                    # default is 2 hours
	option netbios-name-servers 192.168.90.2;
	option routers 192.168.90.2;
}
```

重点在`range`，可以设置的ip范围，这里设置为：`192.168.90.177`，具体配置如下：

```conf
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="static"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="ens33"
UUID="6928d49c-5739-41c7-8c00-3b21504f8881"
DEVICE="ens33"
# ======= 自定义 =========
IPADDR="192.168.90.177"
GATEWAY="192.168.90.2"
NETMASK="255.255.255.0"
DNS1="180.76.76.76"
ONBOOT="yes"
```

> SSH连接很慢或认证失败解决方案

1. `cd /etc/ssh/sshd_config`

2. ```conf
   把
   # UseDNS yes
   修改为
   UseDNS no
   然后，重启ssh服务
   systemctl restart sshd
   ```

## 环境部署

### docker配置

镜像加速：

```bash
# 1. vim /etc/docker/daemon.json 添加
{
  "registry-mirrors": ["https://hub-mirror.c.163.com"]
}

# 2. 重新启动服务
systemctl daemon-reload
systemctl restart docker
```

### 环境准备

Java: JDK8

Maven: 3.6.3

OS name: "mac os x", version: "10.16", arch: "x86_64", family: "mac”

1. maven配置阿里云mirror：

   ```xml
   <mirror>  
       <id>alimaven</id>  
       <name>aliyun maven</name>  
       <url>http://maven.aliyun.com/nexus/content/groups/public/</url>  
       <mirrorOf>central</mirrorOf>          
   </mirror>
   ```

2. 在idea安装`lombok`插件

3. 在idea安装`MybatisX Plugin`插件(选装)

4. 准备好数据库5.7+或8.0.14+

5. 初始化数据库

   - 脚本路径：`djj-doc/sql`

6. 准备好Redis

7. 准备好注册中心Nacos

   - 下载地址：https://github.com/alibaba/nacos/releases
   - 启动命令地址：`nacos\bin`

> 1. 需要注意JDK不能为11
> 2. Linux/Unix/Mac系统默认是集群模式，所以需要添加standalone改为单机模式
>    sh [startup.sh](http://startup.sh/) -m standalone

8. 修改djj-config/src/main/resources/application-dev.properties中的配置参数：
   1. 数据库配置
   2. redis配置
   3. elasticsearch配置（非必要，日志功能）
   4. sentinel配置（非必要，应用吞吐量展示）
9. 修改djj-config/src/main/resources/bootstrap.properties中nacos地址参数：若为本机启动就改为本机地址。

## 日志中心

具体部署参考：[日志中心](../e-function/日志中心.md)

## CICD

### Gitlab

1. 下载镜像：`docker pull gitlab/gitlab-ce`

2. 运行GitLab：

   ```bash
   docker run --detach \
              --publish 8443:443 \
              --publish 8480:80 \
              --publish 2222:22 \
              --name gitlab \
              gitlab/gitlab-ce:latest
   ```

3. 拷贝配置文件：`docker cp  gitlab:/etc/gitlab/ /opt/gitlab/config/`

4. 修改gitlab配置：`vim /opt/gitlab/config/gitlab.rb`

   1. 修改邮箱配置：

      ```conf
      ### Email Settings
      gitlab_rails['gitlab_email_enabled'] = true
      gitlab_rails['gitlab_email_from'] = 'xxx@163.com'
      gitlab_rails['gitlab_email_display_name'] = 'zlt'
      
      gitlab_rails['smtp_enable'] = true
      gitlab_rails['smtp_address'] = "smtp.163.com"
      gitlab_rails['smtp_port'] = 465
      gitlab_rails['smtp_user_name'] = "xxx@163.com"
      gitlab_rails['smtp_password'] = "客户端授权密码"
      gitlab_rails['smtp_domain'] = "smtp.163.com"
      gitlab_rails['smtp_authentication'] = "login"
      gitlab_rails['smtp_enable_starttls_auto'] = true
      gitlab_rails['smtp_tls'] = true
      ```

   2. 设置外部url（[参考资料](https://blog.csdn.net/atlasun/article/details/115749373))：

      ```
      external_url 'http://192.168.90.177:8480'
      ```

   3. 如果ssh端口不是22需要修改端口配置：

      ```
      gitlab_rails['gitlab_shell_ssh_port'] = 2222
      ```

5. 创建启动文件`vim start.sh`

   ```shel
   #!/bin/bash
   GITLAB_DIR=/opt/gitlab
   docker stop gitlab
   docker rm gitlab
   docker run -d \
       -p 8443:443 -p 8480:8480 -p 2222:22 \
       --name gitlab \
       -v ${GITLAB_DIR}/config:/etc/gitlab \
       -v ${GITLAB_DIR}/logs:/var/log/gitlab \
       -v ${GITLAB_DIR}/data:/var/opt/gitlab \
       --privileged=true \
       gitlab/gitlab-ce:latest
   ```

   *修改HOST_NAME为自己喜欢的名字*
   *GITLAB_DIR为挂载目录要修改为自己的目录*

6. 重新启动容器：`sh start.sh`

