# 微服务监控



## Spring Boot Admin

> 实现微服务监控

服务名称：sc-admin：8150

服务位置：djj-monitor -> sc-admin

配置说明：

```yml
server:
  port: 8150

spring:
  application:
    name: sc-admin
  security:
    user:
      name: 'admin'
      password: 'admin'
  cloud:
    nacos:
      discovery:
        metadata:
          user.name: ${spring.security.user.name}
          user.password: ${spring.security.user.password}
```

实现参考：https://www.jianshu.com/p/05ee63c5b932

## 日志埋点

日志埋点的步骤：

1. 数据生成（埋点）
2. 数据收集
3. 数据解析（结构化）
4. 数据落盘
5. 数据使用（展示/分析）

### 实现流程

#### 一、数据生成

数据生成-Logback等日志矿机即可，通过AOP来生成指定的埋点日志。

1. 所有的埋点日志必须约定好统一的格式：
   `{时间}|{来源}|{对象id}|{类型}|{对象属性(以&分割)}`
2. 避免埋点日志文件和系统本身输出的日子混淆，通过配置Logback独立提取成一个文件。

例子：

```bash
2022-01-23 13:17:40.442|sc-gateway|1|request-statistics|ip=127.0.0.1&browser=CHROME&operatingSystem=MAC_OS_X
```

实现：

```java
@Component
public class RequestStatisticsFilter implements GlobalFilter, Ordered {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        Map<String, String> headers = request.getHeaders().toSingleValueMap();
        UserAgent userAgent = UserAgent.parseUserAgentString(headers.get("User-Agent"));
        //埋点
        PointUtil.debug("1", "request-statistics",
            "ip=" + ReactiveAddrUtil.getRemoteAddr(request)
                + "&browser=" + ReactiveAddrUtil.getBrowser(userAgent.getBrowser().name())
                + "&operatingSystem=" +
                ReactiveAddrUtil.getOperatingSystem(userAgent.getOperatingSystem().name()));

        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

#### 二、数据收集

数据收集需要每个服务器部署一个收集中间件。消息队列不是必要的，消息队列的存在主要解决：

1. 削峰填谷，减轻后面日志解析压力。
2. 数据共享，可以增加多个消费端，提供给其它地方使用。

#### 三、数据解析

使用Logstash的*grok*表达式解析日志数据并结构化。

#### 四、数据落盘

通过Logstash能自动创建Elasticsearch索引并以天为单位分片。

#### 五、数据使用

日志数据落盘到Elasticsearch，就可以通过聚合查询等方式实时显示监控数据或者分析日志数据。

### 总结

`日志埋点` 只是其中一种埋点手段而已，**优点是系统无入侵且灵活**；日志收集、解析、落盘等都可以灵活搭配选择不同的中间件，并且不需要修改源系统的代码；并且可以方便对接其他分析平台(例如: 大数据平台)

**PS**：业务监控是否可以不做日志埋点，直接查询业务的数据库呢？(不建议这样做)

1. 使用日志埋点能实现监控数据与业务数据分离，监控平台不会影响或增加业务数据库的压力

2. 使用日志埋点能方便实现实时业务数据预警

   > 举个栗子：日志收集后面添加**流计算中间件**，计算某个时间窗口内优惠卷日志的数量或者金额大于某个阀值，则发出预警

实现参考：https://mp.weixin.qq.com/s/-zsJHE4NLWP73ovjwrPAIA