# 文件中心

## OSS

### 简介

「What」（Object Storage Service，简称 OSS）。

> 阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。OSS可用于图片、音视频、日志等海量文件的存储。各种终端设备、Web网站程序、移动应用可以直接向OSS写入或读取数据。

**相关概念**

1. Endpoint：访问域名，通过该域名可以访问OSS服务的API，进行文件上传、下载等操作。
2. Bucket：存储空间，是存储对象的容器，所有存储对象都必须隶属于某个存储空间。
3. Object：对象，对象是 OSS 存储数据的基本单元，也被称为 OSS 的文件。
4. AccessKey：访问密钥，指的是访问身份验证中用到的 AccessKeyId 和 AccessKeySecret。

## 运行流程

![img](https://cdn.jsdelivr.net/gh/edgarding77/images@latest/func/file-center1.png)

## 使用

七牛云的对象存储：https://developer.qiniu.com/kodo

阿里云使用案例：http://www.macrozheng.com/#/architect/mall_arch_10

- 开通OSS服务：https://help.aliyun.com/document_detail/31884.html?spm=a2c4g.11186623.6.566.74b87eaebrfQno
- 创建存储空间：https://help.aliyun.com/document_detail/31885.html?spm=a2c4g.11186623.6.567.496228bcVZUZqB
- 跨域资源共享（CORS）:https://help.aliyun.com/document_detail/31928.html?spm=5176.11065259.1996646101.searchclickresult.4d1a5607Pf3e9i
- 服务端签名直传并设置上传回调:https://help.aliyun.com/document_detail/31927.html?spm=a2c4g.11186623.6.1268.2c256506mNqV1t

## 项目实现

- Github开发参考：https://github.com/adlered/Picuang
- Gitee实现参考：https://blog.51cto.com/u_15352995/3753170
- Gitee API：https://gitee.com/api/v5/swagger#/postV5ReposOwnerRepoContentsPath

本项目通过Gitee作为图床存储，这里以上传文件为例子。具体逻辑查看模块**file-center**。

### Parameters

| Parameter | Value | Description | Type | Data Type |
| :-------- | :---- | :---------- | :--- | :-------- |
|           |       |             |      |           |

| access_token     |      | 用户授权码                                   | formData | string |
| ---------------- | ---- | -------------------------------------------- | -------- | ------ |
| owner*           |      | 仓库所属空间地址(企业、组织或个人的地址path) | path     | string |
| repo*            |      | 仓库路径(path)                               | path     | string |
| path*            |      | 文件的路径                                   | path     | string |
| content*         |      | 文件内容, 要用 base64 编码                   | formData | string |
| message*         |      | 提交信息                                     | formData | string |
| branch           |      | 分支名称。默认为仓库对默认分支               | formData | string |
| committer[name]  |      | Committer的名字，默认为当前用户的名字        | formData | string |
| committer[email] |      | Committer的邮箱，默认为当前用户的邮箱        | formData | string |
| author[name]     |      | Author的名字，默认为当前用户的名字           | formData | string |
| author[email]    |      | Author的邮箱，默认为当前用户的邮箱           | formData | string |

### 具体实现

**准备**

1. 获取owner名称，repo仓库名
2. 请求模版：`https://gitee.com/api/v5/repos/{owner}/{repo}/contents/{path}`

**实体类设计**

```java
@Data
@EqualsAndHashCode(callSuper = false)
@TableName("file_info")
public class FileInfo extends SuperEntity<FileInfo> {
    private static final long serialVersionUID = -2503526236503444922L;
    /**
     * 文件名
     */
    private String filename;
    /**
     * 是否为图片
     */
    private Boolean isImg;
    /**
     * 文件类型 image/jpg,image/png...
     */
    private String contentType;
    /**
     * 文件大小
     */
    private Long size;
    /**
     * 冗余字段
     */
    private String path;
    /**
     * 访问路径
     */
    private String url;
    /**
     * 存储源
     */
    private String source;
    /**
     * 文件的 Blob SHA，可通过 [获取仓库具体路径下的内容] API 获取
     */
    private String sha;
}
```

1. 将文件转化FileInfo

   ```java
       /**
        * 转化为fileInfo
        *
        * @param file
        * @return
        */
       private FileInfo getFileInfo(MultipartFile file) {
           FileInfo fileInfo = new FileInfo();
           fileInfo.setFilename(System.currentTimeMillis() + "_" + file.getOriginalFilename());
           fileInfo.setContentType(file.getContentType());
           fileInfo.setIsImg(fileInfo.getContentType().startsWith("image/"));
           fileInfo.setSize(file.getSize());
           fileInfo.setSource(fileUploadProperties.getSource());
           fileInfo.setPath(fileUploadProperties.getPath() + fileInfo.getFilename());
           return fileInfo;
       }
   ```

2. targetUrl上传url的设计:

   ```java
       private String createUploadFileUrl(FileInfo fileInfo) {
           return String.format(fileUploadProperties.getApiCreatePost(),
               fileUploadProperties.getOwner(),
               fileUploadProperties.getRepo(),
               fileInfo.getPath());
       }
   ```

3. 具体请求逻辑：

   ```java
                String targetUrl = createUploadFileUrl(fileInfo);
               //请求体封装
               Map<String, Object> uploadBodyMap = getUploadBodyMap(file.getBytes());
               //借助HttpUtil工具类发送POST请求
               String jsonRes = HttpUtil.post(targetUrl, uploadBodyMap);
               //解析响应JSON字符串
               JSONObject jsonObj = JSONUtil.parseObj(jsonRes);
               //请求失败
               if (jsonObj.getObj("commit") == null) {
                   return CommonResult.failed(jsonObj, "请求失败");
               }
               //请求成功：返回下载地址
               JSONObject content = JSONUtil.parseObj(jsonObj.getObj("content"));
               JSONObject commit = JSONUtil.parseObj(jsonObj.getObj("commit"));
               fileInfo.setUrl(content.getObj("download_url").toString());
               fileInfo.setSha(commit.getObj("sha").toString());
   ```

   







