# 审计日志

## Introduction

[维基百科](https://en.wikipedia.org/wiki/Audit_trail): "审计跟踪(也称为**审计日志**)是一种安全相关的按时间顺序记录，记录集或记录目的和来源。这种记录提供了在任何特定时间的操作、过程或事件产生影响活动顺序的文件证据 "。

## 使用说明

审计信息默认输出到logger文件中：logs/audit/audit.log

审计日志格式为：`"%{TIMESTAMP:logTime}\|%{MYAPPNAME:appName}\|%{MYTHREADNAME:className}\|%{WORD:methodName}\|%{MYAPPNAME:userId}\|%{MYAPPNAME:userName}\|%{MYAPPNAME:clientId}\|%{GREEDYDATA:operation}"`

配置：`djj.audit-log.type`可以选择以logger或db的方式存储

使用方式：

1. 添加依赖

   ```xml
   <dependency>
     <groupId>top.edgarding</groupId>
     <artifactId>djj-log-spring-boot-starter</artifactId>
   </dependency>
   ```

2. 开启审计日志

   ```yml
     # 审计日志
     audit-log:
       enable: true # 默认为false
       type: db # 默认logger ｜ db
       datasource: # 自定义数据源，否则当前的
         jdbc-url: jdbc:mysql://${djj.datasource.ip}:3306/logger-center?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&useSSL=false&zeroDateTimeBehavior=convertToNull&serverTimezone=Asia/Shanghai
         username: ${djj.datasource.username}
         password: ${djj.datasource.password}
         driver-class-name: com.mysql.cj.jdbc.Driver
   ```

3. 添加注解到需要审计的方法上`@AuditLog()`，如果在类上添加，则所有的方法都生效

   ```java
       @PostMapping(value = "/users/saveOrUpdate")
       @ApiOperation("新增或更新用户")
       @AuditLog(operation = "'新增或更新用户:' + #sysUser.username")
       @CacheEvict(value = "user", key = "#sysUser.username")
       public CommonResult saveOrUpdate(@RequestBody SysUser sysUser) throws Exception {
           if (sysUserService.checkIsAdmin(sysUser.getId())) {
               return CommonResult.failed("ADMIN用户不可修改");
           }
           return sysUserService.saveOrUpdateUser(sysUser);
       }
   ```

## 具体实现

AuditLogProperties配置如下：

- enable{true|false}
- type{logger|db}

通过AuditLogAspect，将@AuditLog注解解析，获取操作内容，并进行logger的打印或存入到db中。

切点JoinPoint为：

```java
    @Before("@within(auditLog) || @annotation(auditLog)")
    public void beforeMethod(JoinPoint joinPoint, AuditLog auditLog) {
        if (auditLogProperties.getEnable()) {
            if (auditService == null) {
                log.warn("AuditLogAspect - auditService is null");
                return;
            }
            if (auditLog == null) {
                // 获取类上注解
                auditLog = joinPoint.getTarget().getClass().getDeclaredAnnotation(AuditLog.class);
            }
            Audit audit = getAudit(auditLog, joinPoint);
            auditService.save(audit);
        }
    }
```

AuditLog日志的结构如下：

```java
public class Audit {
    private LocalDateTime timestamp; // 时间戳
    private String applicationName; // 应用名
    private String className; // 类名
    private String methodName; // 方法名
    private String userId; // 用户ID
    private String username; // 用户名
    private String clientId; // 租户ID
    private String operation; // 操作信息
}

```

审计日志的实现类：

```java
@Slf4j
@ConditionalOnProperty(name = "djj.audit-log.type", havingValue = "logger", matchIfMissing = true)
public class LoggerAuditServiceImpl implements AuditService {
    private static final String MSG_PATTERN = "{}|{}|{}|{}|{}|{}|{}|{}";
    @Override
    public void save(Audit audit) {
        log.debug(MSG_PATTERN
            , audit.getTimestamp().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss.SSS"))
            , audit.getApplicationName(), audit.getClassName(), audit.getMethodName()
            , audit.getUserId(), audit.getUsername(), audit.getClientId()
            , audit.getOperation());
    }
}

```

其中，以日志形式展现为默认方式，还可以通过修改修改`djj.audit-log.type`为db，将审计日志存入数据库中。

若是使用数据库存储，若没有配置数据源，这使用默认的数据库连接池**Hikari**，初始化表格。

## Reference

- https://docs.abp.io/zh-Hans/abp/latest/Audit-Logging
- 阿里云文档-日志审计服务概览：https://help.aliyun.com/document_detail/164065.html
